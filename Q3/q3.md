# Q3项目详细说明文档

## 项目概览

Q3项目旨在解决NIPT（无创产前检测）中的一个核心问题：如何根据孕妇的BMI等多因素特征，确定最佳的检测时点，以在保证检测成功的前提下尽早给出结果。

### 核心问题
- **目标**：最小化孕妇潜在风险
- **约束**：保证Y染色体浓度达标（≥4%）且测序成功
- **影响因素**：BMI、孕周、GC%、读段数、年龄等
- **输出**：BMI分组方案和各组最佳检测时点

## 技术创新点

### 1. 双通道交叉验证方法
```
通道A（纵向建模）        通道B（生存分析）
    ↓                       ↓
达标概率 + 成功率        区间删失建模
    ↓                       ↓
风险函数优化             生存函数估计
    ↓                       ↓
    结果交叉验证和对比
```

### 2. 动态阈值调整
传统方法使用固定4%阈值，我们的方法考虑检测误差：
```
调整阈值 = 4% + z_α × σ(t,BMI)
```
其中σ(t,BMI)是依赖于时间和BMI的检测误差。

### 3. 多目标风险函数
```
总风险 = 时间风险 + 失败风险 + 重检成本
       λ(t)    + γ×[1-P成功]  + 延迟惩罚
```

## 数据准备指南

### 数据格式要求
```csv
ID,gest_week,BMI,Y_pct,GC,readcount,age,height,weight,draw_success
P001,12.5,23.4,0.045,42.1,15000000,28,165,63.8,1
P001,13.0,23.4,0.052,41.8,16500000,28,165,63.8,1
P002,11.8,31.2,0.038,43.2,14200000,32,158,78.0,1
...
```

### 字段说明
- **ID**: 患者唯一标识符
- **gest_week**: 孕周（10-25周范围）
- **BMI**: 体质指数（基于首次检测时的身高体重）
- **Y_pct**: Y染色体浓度（小数形式，如0.045表示4.5%）
- **GC**: GC含量百分比
- **readcount**: 测序读段数
- **age**: 孕妇年龄
- **height**: 身高（cm）
- **weight**: 体重（kg）
- **draw_success**: 采血成功标志（1=成功，0=失败）

### 数据质量要求
1. **完整性**: 核心字段缺失率<5%
2. **一致性**: 同一患者的BMI保持稳定
3. **覆盖性**: 每个BMI区间在10-25周都有观测
4. **样本量**: 每组至少50个个体

## 使用示例

### 基础运行
```bash
# 1. 准备环境
pip install -r requirements.txt

# 2. 准备数据
cp your_data.csv data/q3_preprocessed.csv

# 3. 运行分析
python run_analysis.py --config config.yaml --data data/q3_preprocessed.csv
```

### 高级配置示例

#### 1. 修改BMI分组策略
```yaml
# config.yaml
grouping:
  method: "hybrid"  # 或 "tree", "dp", "custom"
  who_cuts: [18.5, 25.0, 30.0, 35.0]  # 自定义WHO切点
  constraints:
    min_group_size: 100  # 增加最小组内样本量
    min_cut_distance: 3.0  # 增加最小切点间距
```

#### 2. 调整风险函数权重
```yaml
# config.yaml  
optimization:
  risk_weights:
    time_weights: [0.5, 2.0, 5.0]  # 更保守的时间惩罚
    failure_cost: 3.0  # 降低失败代价
```

#### 3. 启用重检策略优化
```yaml
# config.yaml
optimization:
  retest_strategy:
    enabled: true
    max_delay: 2.5
    delay_options: [1.0, 1.5, 2.0]
```

### 敏感性分析示例
```bash
# 测试不同阈值的影响
python run_analysis.py --config config_sensitivity.yaml --data data/q3_preprocessed.csv

# 其中config_sensitivity.yaml包含：
sensitivity:
  threshold_sensitivity:
    enabled: true
    threshold_range: [3.0, 3.5, 4.0, 4.5, 5.0]
  
  bootstrap:
    enabled: true
    n_samples: 1000  # 增加Bootstrap样本数
```

## 结果解释

### 主结果表格（bmi_groups_optimal.csv）
```csv
BMI_Group,BMI_Range,Recommended_Week,Median_BMI,P_Attain,P_Success,P_Detect,CI_Lower,CI_Upper,N_Subjects
G1,"[18.5, 25.0)",11.5,22.1,0.82,0.95,0.78,11.0,12.0,145
G2,"[25.0, 30.0)",12.8,27.3,0.79,0.92,0.73,12.3,13.3,387
G3,"[30.0, 35.0)",14.2,32.4,0.75,0.88,0.66,13.7,14.7,298
G4,"[35.0, 40.0]",16.0,37.8,0.71,0.83,0.59,15.5,16.5,124
```

### 关键指标解释
- **Recommended_Week**: 该BMI组的推荐检测时点
- **P_Attain**: 达标概率（Y浓度≥4%的概率）
- **P_Success**: 测序成功概率
- **P_Detect**: 综合检测成功概率（P_Attain × P_Success）
- **CI_Lower/Upper**: 推荐时点的95%置信区间

### 结果验证指标
1. **生物学合理性**: BMI增加→推荐时点后移
2. **统计显著性**: 组间差异的p值<0.05
3. **预测准确性**: 交叉验证AUC>0.75
4. **稳健性**: 敏感性分析中结果变化<10%

## 常见问题解答

### Q1: 为什么要用双通道方法？
**A**: 单一建模方法可能存在模型偏差。双通道方法通过纵向建模和生存分析两种独立方法交叉验证，提高结果的可靠性。

### Q2: 如何选择BMI分组数量？
**A**: 系统会基于数据特征自动确定。一般来说：
- 样本量>1000: 4-5组
- 样本量500-1000: 3-4组  
- 样本量<500: 2-3组

### Q3: 推荐时点的置信区间如何理解？
**A**: 置信区间反映了推荐时点的不确定性。区间越窄说明估计越精确。临床应用时可以在此区间内灵活选择具体时点。

### Q4: 敏感性分析显示结果不稳定怎么办？
**A**: 可能的原因和解决方案：
- 样本量不足 → 增加数据或合并相近组别
- 模型过拟合 → 降低模型复杂度
- 参数设置不合理 → 调整风险函数权重

### Q5: 如何处理极端BMI值？
**A**: 系统自动处理：
- BMI<18.5或>45的个体会被标记为"特殊情况"
- 这些个体的预测会增加不确定性警告
- 建议临床医生基于个案判断

## 方法学对比

### 与传统方法的对比
| 方面 | 传统方法 | Q3方法 |
|------|----------|--------|
| 阈值 | 固定4% | 动态调整 |
| 分组 | 经验分组 | 数据驱动 |
| 验证 | 单一指标 | 交叉验证 |
| 误差 | 忽略 | 显式建模 |
| 个体化 | 无 | 基于BMI等因素 |

### 性能提升预期
- 检测成功概率提升: 8-15%
- 平均检测时点优化: 提前1-2周（同等成功率下）
- 重检率降低: 20-30%

## 技术路线图

### Phase 1: 核心建模（已完成）
- [x] 数据预处理框架
- [x] 双通道建模设计
- [x] 风险函数定义
- [x] BMI分组算法

### Phase 2: 算法实现（进行中）
- [ ] 达标概率建模
- [ ] 成功率建模  
- [ ] 生存分析实现
- [ ] 优化算法

### Phase 3: 验证评估（待开始）
- [ ] 交叉验证框架
- [ ] 敏感性分析
- [ ] Bootstrap置信区间
- [ ] 基线对比

### Phase 4: 结果输出（待开始）
- [ ] 报告生成
- [ ] 图表可视化
- [ ] 用户界面
- [ ] 文档完善

## 贡献指南

### 代码结构
```
src/
├── __init__.py          # 包初始化
├── cli.py              # 命令行接口
├── dataio.py           # 数据IO
├── utils.py            # 通用工具
├── models/             # 建模模块
│   ├── attain_model.py
│   ├── success_model.py  
│   └── survival_model.py
├── optimize.py         # 优化算法
├── grouping.py         # 分组算法
├── sensitivity.py      # 敏感性分析
└── plots.py           # 可视化
```

### 代码规范
1. **文档字符串**: 所有函数必须有完整的docstring
2. **类型注解**: 使用typing模块进行类型注解
3. **错误处理**: 合适的异常处理和日志记录
4. **测试覆盖**: 核心功能需要单元测试

### 提交流程
1. Fork项目仓库
2. 创建功能分支 (`git checkout -b feature/new-feature`)
3. 提交更改 (`git commit -am 'Add new feature'`)
4. 推送到分支 (`git push origin feature/new-feature`)
5. 创建Pull Request

## 引用和致谢

如果使用此项目的方法或代码，请引用：
```
@misc{q3_nipt_optimization,
  title={基于多因素与误差稳健的BMI分组与最佳NIPT时点优化},
  author={Q3项目组},
  year={2024},
  url={https://github.com/your-repo/q3-nipt}
}
```

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 联系方式

- 项目维护: Q3项目组
- 技术支持: 请在GitHub Issues中提问
- 邮件联系: q3-project@example.com

---
最后更新: 2024年1月  
版本: v1.0.0