# Q2: 男胎孕妇BMI分组与NIPT最佳检测时点分析

## 📋 项目概述

本项目针对**问题2：男胎孕妇BMI对胎儿Y染色体浓度达标时间的影响分析**，通过建立分位数回归模型和失败风险模型，对男胎孕妇的BMI进行合理分组，给出每组的BMI区间和最佳NIPT检测时点，以最小化孕妇的潜在风险。

### 🎯 核心目标
- 建立Y染色体浓度与孕周、BMI的数学模型
- 确定不同BMI分组的最佳NIPT检测时点
- 分析检测误差对结果的影响
- 提供临床实用的风险最小化策略

## 📁 项目结构

```
Q2/
├── README.md                           # 项目总览文档（本文件）
├── strategy.md                         # 整体建模策略和论文大纲
├── appendix.xlsx                       # 原始数据文件（男胎检测数据）
├── bmi_groups_working.csv              # BMI分组结果（工作版本）
├── wstar_curve_working.csv             # 最佳时点曲线数据（工作版本）
├── bmi_groups_fast.csv                 # BMI分组结果（快速版本）
├── wstar_curve_fast.csv                # 最佳时点曲线数据（快速版本）
├── step2_1/                            # 数据预处理模块
│   ├── data_processing.py              # 数据清洗和预处理脚本
│   ├── 2_1.md                          # 数据处理详细说明
│   ├── step1_long_records.csv          # 处理后的逐次检测长表
│   ├── step1_report.csv                # 数据质量报告
│   └── step1_surv_dat.csv              # 生存分析事件-删失表
└── step2_2/                            # 主分析模块
    ├── p2.py                           # 主分析程序
    ├── README.md                       # 详细技术文档
    ├── 2_2.md                          # 建模策略说明
    ├── appendix.xlsx                   # 补充数据（QC指标）
    ├── step1_long_records.csv          # 输入数据（来自step2_1）
    ├── bmi_groups_tau90_delta10_thr40.csv    # BMI分组结果
    ├── wstar_curve_tau90_delta10_thr40.csv   # 最佳时点曲线数据
    ├── main_analysis.png               # 主分析可视化图表
    └── sensitivity_analysis.png        # 敏感性分析图表
```

## 🔄 工作流程

### 阶段1：数据预处理 (step2_1)
1. **数据清洗**：从原始Excel文件中提取核心变量
2. **孕周统一化**：将文本格式孕周转换为小数周数
3. **BMI计算**：重新计算并校验BMI值
4. **浓度标准化**：统一Y染色体浓度格式
5. **同日检测处理**：处理同一孕妇同日多次检测的情况
6. **数据结构化**：生成逐次检测长表和事件-删失表

### 阶段2：建模分析 (step2_2)
1. **分位数回归建模**：建立Y染色体浓度预测模型
2. **失败风险建模**：预测检测失败概率
3. **最佳时点优化**：寻找同时满足浓度和风险条件的最优时点
4. **BMI分组**：基于数据驱动和WHO标准进行智能分组
5. **敏感性分析**：验证结果稳健性
6. **结果可视化**：生成综合分析图表

## 🧮 核心算法

### 1. 分位数回归模型
```python
# 使用GAM模型和增强GBR模型
# 预测Y染色体浓度随孕周和BMI的变化
Y_concentration = f(gestational_week, BMI, interaction_terms)
```

### 2. 失败风险模型
```python
# 逻辑回归预测检测失败概率
P(failure) = logistic(β₀ + β₁×week + β₂×BMI + β₃×week² + β₄×BMI² + β₅×week×BMI)
```

### 3. 最佳检测时点判定
```python
# 双条件约束优化
条件1: Y_concentration ≥ 4% (τ=0.90分位数)
条件2: P(failure) ≤ 10%
最优时点 = min{week | 条件1 AND 条件2}
```

### 4. BMI分组策略
```python
# 混合方法：WHO标准 + 数据驱动
初始切点 = [18.5, 25.0, 30.0]  # WHO标准
数据驱动调整 = 回归树分析(最佳时点 vs BMI)
最终分组 = 智能合并(初始切点, 数据驱动结果)
```

## 📊 主要结果

### BMI分组结果

| 分组 | BMI范围 | 推荐检测时点 | 样本数 | 成功率 |
|------|---------|-------------|--------|--------|
| 低BMI组 | [25.0, 30.0) | 8.0周 | 2 | 100% |
| 高BMI组 | ≥ 30.0 | 22.0周 | 20 | 95% |

### 关键发现
- **总分组数**：2个BMI分组
- **时点差异**：14.0周（8.0周 vs 22.0周）
- **BMI影响**：高BMI组需要显著延迟检测
- **风险控制**：90%置信度，10%失败风险

### 模型性能
- **MSE改进**：相比基线模型提升26.9%
- **MAE改进**：相比基线模型提升19.3%
- **交叉验证**：5折CV确保泛化能力

## 🚀 快速开始

### 环境要求
```bash
pip install pandas numpy scikit-learn matplotlib seaborn scipy openpyxl
```

### 运行完整分析
```bash
# 1. 数据预处理
cd step2_1
python data_processing.py

# 2. 主分析
cd ../step2_2
python p2.py
```

### 参数配置
在`step2_2/p2.py`中可以调整以下关键参数：

```python
# 核心参数
TAU = 0.90          # 分位数：0.90/0.95/0.50
THR = 0.04          # 达标阈值（4%）
SIGMA = 0.00        # 测量误差标准差
DELTA = 0.10        # 失败风险容忍度（10%）
W_MIN, W_MAX = 8.0, 22.0  # 搜索孕周范围

# 模型参数
USE_GAM = False     # 是否使用GAM模型
USE_CV = False      # 是否进行交叉验证
USE_QC = False      # 是否使用QC指标
```

## 📈 敏感性分析

### 阈值敏感性
- **3.5%阈值**：时点范围14.0周
- **4.0%阈值**：时点范围14.0周  
- **4.5%阈值**：时点范围14.0周

### 失败风险容忍度
- **δ=5%**：时点范围0.0周
- **δ=10%**：时点范围14.0周
- **δ=15%**：时点范围12.5周

### 测量误差影响
- **0%误差**：基准结果
- **1%误差**：时点微调
- **2%误差**：时点显著调整

## 🏥 临床建议

### 风险最小化策略
1. **低BMI孕妇（< 30）**：
   - 推荐检测时点：8.0周
   - 优势：早期检测，降低妊娠风险
   - 注意事项：确保胎儿DNA浓度充足

2. **高BMI孕妇（≥ 30）**：
   - 推荐检测时点：22.0周
   - 原因：BMI高导致胎儿DNA浓度低
   - 策略：延迟检测确保准确性

### 个体化建议
- 根据孕妇BMI自动推荐最佳检测时点
- 考虑检测误差的稳健性调整
- 提供90%置信度的预测区间

## 🔬 技术特点

### 建模方法
- **分位数回归**：捕捉Y染色体浓度的分布特征
- **广义加性模型**：处理非线性关系
- **逻辑回归**：预测检测失败风险
- **决策树**：数据驱动的BMI分组
- **交叉验证**：确保模型泛化能力

### 特征工程
- 二次项和交互项建模
- 标准化和归一化处理
- QC指标整合
- 稳健性异常值处理

### 可视化
- 多维度图表展示
- 中文字体支持
- 高分辨率输出
- 交互式分析界面

## 📚 依赖库

```python
pandas>=1.3.0        # 数据处理和分析
numpy>=1.21.0        # 数值计算
scikit-learn>=1.0.0  # 机器学习算法
matplotlib>=3.4.0    # 基础绘图
seaborn>=0.11.0      # 统计绘图
scipy>=1.7.0         # 科学计算
openpyxl>=3.0.0      # Excel文件处理
```

## 📝 文件说明

### 数据文件
- **`appendix.xlsx`**：原始男胎检测数据
- **`step1_long_records.csv`**：处理后的逐次检测记录
- **`step1_surv_dat.csv`**：生存分析事件-删失数据
- **`bmi_groups_*.csv`**：BMI分组结果
- **`wstar_curve_*.csv`**：最佳时点曲线数据

### 代码文件
- **`data_processing.py`**：数据预处理脚本
- **`p2.py`**：主分析程序
- **`*.md`**：详细文档说明

### 结果文件
- **`main_analysis.png`**：主分析可视化
- **`sensitivity_analysis.png`**：敏感性分析图表
- **`*_results.txt`**：数值结果报告

## ⚠️ 注意事项

1. **数据质量**：确保输入数据格式正确，缺失值处理合理
2. **参数调整**：根据实际需求调整模型参数
3. **字体支持**：可视化需要中文字体支持
4. **环境要求**：建议在Python 3.7+环境中运行
5. **内存需求**：大数据集可能需要足够的内存空间

## 🔄 版本历史

- **v1.0** (2025-01): 初始版本，包含基础分析功能
- **v1.1** (2025-01): 增加敏感性分析和可视化
- **v1.2** (2025-01): 优化BMI分组算法和结果展示

## 👥 作者信息

- **项目**：MCM数学建模竞赛
- **功能**：BMI分组与NIPT最佳检测时点分析
- **版本**：v1.2
- **更新日期**：2025年1月

## 📄 许可证

本项目为数学建模竞赛作品，仅供学术研究使用。

---

*如有问题或建议，请查看各子模块的详细README文档。*
