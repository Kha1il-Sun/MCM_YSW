# Problem 2: BMI 分组与最佳 NIPT 时点优化

## 概述

本模块实现了基于 BMI 的孕妇分组和最佳 NIPT 检测时点优化，采用两条并行通道（纵向/分位数与区间删失/生存）交叉验证，确保结果的稳健性和临床可解释性。

## 主要功能

1. **数据预处理**: 读取和校验 Step1 产物
2. **σ估计**: 构建局部/全局σ查表器
3. **纵向建模**: μ(t,b)/p_hit(t,b) 分位数回归
4. **失败建模**: q_fail(t,b) 情景函数
5. **生存建模**: AFT/PH 区间删失拟合
6. **风险函数**: S版/误差修正版风险函数
7. **优化求解**: w*(b) 数值求解和保序处理
8. **BMI分组**: WHO起点+决策树/DP微调
9. **结果输出**: 表格、图表、报告

## 目录结构

```
step2_2/
├── p2.py                    # 主程序入口
├── config/
│   └── step2_config.yaml   # 配置文件
├── data/                    # 数据文件（来自step2_1）
├── src/                     # 源代码模块
│   ├── io_utils.py         # I/O工具
│   ├── sigma_lookup.py     # σ查表/插值
│   ├── models_long.py      # 纵向通道模型
│   ├── models_fail.py      # 失败通道模型
│   ├── models_surv.py      # 生存通道模型
│   ├── objective.py        # 风险函数
│   ├── optimize.py         # 优化求解
│   └── grouping.py         # BMI分组
├── outputs/                 # 输出结果
└── requirements.txt        # 依赖包
```

## 使用方法

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行分析

```bash
python p2.py
```

### 3. 自定义配置

编辑 `config/step2_config.yaml` 文件来调整参数：

- 模型参数（分位数回归、AFT分布等）
- 风险函数权重
- 优化参数
- BMI分组策略
- 输出设置

## 输出结果

### 主要文件

- `p2_wstar_curve.csv`: w*(b) 曲线数据
- `p2_group_recommendation.csv`: BMI分组推荐
- `main_analysis.png`: 主分析图表
- `p2_report.txt`: 分析报告
- `step2_config_used.yaml`: 使用的配置

### 关键指标

1. **w*(b) 曲线**: 每个BMI值的最优检测时间
2. **BMI分组**: 基于WHO标准的优化分组
3. **推荐时点**: 每组的推荐检测时间
4. **风险评估**: 不同策略的风险对比
5. **敏感性分析**: 参数扰动的影响

## 数学模型

### 风险函数

**误差修正版 (EC)**:
```
R(t,b) = w₁[1-p_succ(t,b)] + w₂Delay(t) + w₃Redraw(t,b)
```

**生存版 (S)**:
```
R_S(t,b) = w₁S(t|b) + w₂Delay(t) + w₃Redraw(t,b)
```

### 成功概率

```
p_succ(t,b) = (1-q_fail(t,b)) × p_hit(t,b)
p_hit(t,b) = Φ((μ(t,b) - thr_adj(t,b))/σ(t,b))
```

### 优化目标

```
w*(b) = argmin_t R(t,b)  subject to  p_succ(t,b) ≥ τ
```

## 技术特点

1. **双通道验证**: 纵向和生存通道交叉验证
2. **保序约束**: 确保BMI↑→时间↑的生理合理性
3. **局部σ估计**: 考虑测量误差的空间变化
4. **区间删失**: 正确处理达标时间的不确定性
5. **配置管理**: 完整的参数记录和复现支持

## 注意事项

1. 确保 Step1 的数据产物完整
2. 检查配置文件的参数设置
3. 注意内存使用（大数据集时）
4. 验证结果的临床合理性

## 故障排除

### 常见问题

1. **数据读取失败**: 检查数据文件路径和格式
2. **模型拟合失败**: 调整模型参数或数据范围
3. **优化不收敛**: 增加容差或调整搜索范围
4. **分组不合理**: 检查约束参数设置

### 日志文件

运行时会生成 `p2.log` 文件，包含详细的执行信息。

## 扩展功能

- 敏感性分析模块
- 验证和交叉验证
- 更多可视化选项
- 批量处理支持

## 联系信息

如有问题，请查看日志文件或联系开发团队。
