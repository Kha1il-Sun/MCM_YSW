# Step2_2: BMI分组与NIPT最佳检测时点分析模块

## 📋 模块概述

本模块是Q2项目的核心分析模块，实现了基于BMI的孕妇分组和最佳NIPT检测时点优化。采用两条并行通道（纵向/分位数与区间删失/生存）交叉验证，确保结果的稳健性和临床可解释性。

### 🎯 核心功能

1. **数据预处理**: 读取和校验Step1产物，确保数据质量
2. **σ估计**: 构建局部/全局σ查表器，建模测量误差
3. **纵向建模**: μ(t,b)/p_hit(t,b)分位数回归预测
4. **失败建模**: q_fail(t,b)情景函数风险评估
5. **生存建模**: AFT/PH区间删失拟合
6. **风险函数**: S版/误差修正版风险函数
7. **优化求解**: w*(b)数值求解和保序处理
8. **BMI分组**: WHO起点+决策树/DP微调
9. **结果输出**: 表格、图表、报告生成

## 📁 目录结构

```text
step2_2/
├── p2.py                    # 主程序入口
├── README.md                # 模块说明文档
├── config/
│   └── step2_config.yaml   # 配置文件
├── data/                    # 数据文件（来自step2_1）
│   ├── step1_long_records.csv
│   ├── step1_surv_dat_fit.csv
│   ├── step1_report.csv
│   └── step1_config.yaml
├── src/                     # 源代码模块
│   ├── io_utils.py         # I/O工具与数据验证
│   ├── sigma_lookup.py     # σ查表与插值
│   ├── models_long.py      # 纵向通道模型
│   ├── grid_search.py      # 网格搜索优化
│   └── grouping.py         # BMI分组算法
├── outputs/                 # 输出结果
│   ├── p2_wstar_curve.csv
│   ├── p2_group_recommendation.csv
│   ├── main_analysis.png
│   └── p2_report.txt
└── requirements.txt        # 依赖包列表
```

## 🚀 使用方法

### 1. 环境准备

确保已完成Step1数据预处理，并生成了以下文件：

- `step1_long_records.csv`: 逐次检测长表
- `step1_surv_dat_fit.csv`: 区间删失表
- `step1_report.csv`: 数据质量报告
- `step1_config.yaml`: Step1配置参数

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 运行分析

```bash
# 基础运行
python p2.py

# 详细输出模式
python p2.py --verbose

# 自定义配置
python p2.py --config config/custom_config.yaml
```

### 4. 参数配置

编辑 `config/step2_config.yaml` 文件来调整参数：

```yaml
model_params:
  quantile_tau: 0.90          # 分位数水平
  use_gam: true              # 使用GAM模型

optimization:
  thr_adj: 0.04              # 浓度阈值（4%）
  delta: 0.10                # 失败风险阈值（10%）
  w_min: 8.0                 # 最小孕周
  w_max: 22.0                # 最大孕周

grouping:
  method: "hybrid"           # 分组方法
  who_cuts: [18.5, 25.0, 30.0]  # WHO标准切点
  min_group_n: 10            # 最小组内样本量
```

## 📊 输出结果

### 主要文件

| 文件名 | 格式 | 说明 |
|--------|------|------|
| `p2_wstar_curve.csv` | CSV | w*(b)曲线数据 |
| `p2_group_recommendation.csv` | CSV | BMI分组推荐 |
| `main_analysis.png` | PNG | 主分析图表 |
| `sensitivity_analysis.png` | PNG | 敏感性分析图表 |
| `p2_report.txt` | TXT | 详细分析报告 |
| `step2_config_used.yaml` | YAML | 实际使用的配置 |

### 关键指标

1. **w*(b)曲线**: 每个BMI值的最优检测时间
2. **BMI分组**: 基于WHO标准的优化分组
3. **推荐时点**: 每组的推荐检测时间
4. **风险评估**: 不同策略的风险对比
5. **敏感性分析**: 参数扰动的影响

### 典型结果示例

| 分组ID | BMI范围 | 样本数 | 推荐时点(周) | 时点标准差 |
|--------|---------|--------|-------------|-----------|
| 1 | [18.5, 22.3) | 45 | 12.5 | ±1.2 |
| 2 | [22.3, 26.1) | 78 | 15.2 | ±1.8 |
| 3 | [26.1, 29.9) | 89 | 18.7 | ±2.1 |
| 4 | [29.9, 35.0) | 55 | 22.3 | ±2.5 |

## 🧮 数学模型

### 核心数学模型

#### Y染色体浓度预测

**分位数回归模型**：

```math
Y(t,b) = μ_τ(t,b) + ε(t,b)
```

其中 `μ_τ(t,b) = β₀ + β₁t + β₂b + β₃t² + β₄b² + β₅tb`，使用GradientBoostingRegressor实现。

#### 测量误差建模

**全局σ估计**：`σ_global = √(Σ(y_i - 0.04)² / n)`
**局部σ估计**：`σ(t,b) = σ_local(t,b) + λ(σ_global - σ_local(t,b))`
**调整后阈值**：`thr_adj(t,b) = 0.04 + z_α × σ(t,b)`

#### 成功概率建模

**命中概率**：`p_hit(t,b) = Φ((μ_τ(t,b) - thr_adj(t,b)) / σ(t,b))`
**失败概率**：`p_fail(t,b) = base_rate + early_penalty(t) + bmi_penalty(b)`
**总成功概率**：`p_succ(t,b) = (1 - p_fail(t,b)) × p_hit(t,b)`

#### 风险函数

**误差修正版**：`R_EC(t,b) = w₁[1 - p_succ(t,b)] + w₂Delay(t) + w₃Redraw(t,b)`
**生存版**：`R_S(t,b) = w₁S(t|b) + w₂Delay(t) + w₃Redraw(t,b)`

### 优化算法

#### 最佳时点求解

**约束优化**：`w*(b) = argmin_t R(t,b)` subject to `p_succ(t,b) ≥ τ`
**网格搜索**：双重网格搜索确保全局最优解

#### BMI分组策略

**混合方法**：WHO标准起点 + 数据驱动微调
**约束条件**：最小组内样本量≥10，最小切点间距≥1.0 BMI单位

## 🔬 技术特点

### 核心算法创新

1. **双通道验证**: 纵向和生存通道交叉验证，确保结果稳健性
2. **保序约束**: 确保BMI↑→时间↑的生理合理性
3. **局部σ估计**: 考虑测量误差的空间变化
4. **区间删失**: 正确处理达标时间的不确定性
5. **配置管理**: 完整的参数记录和复现支持

### 工程实现特点

1. **模块化设计**: 清晰的代码架构，便于维护和扩展
2. **向量化计算**: 提高大规模数据处理效率
3. **并行计算**: 多进程网格搜索，提升计算速度
4. **内存优化**: 分块处理大数据集，降低内存占用
5. **错误处理**: 完善的异常处理和日志记录

## ⚠️ 注意事项

### 数据质量要求

1. **数据完整性**: 确保Step1的数据产物完整
2. **数据一致性**: 检查个体ID、BMI字段、孕周范围
3. **参数设置**: 检查配置文件的参数设置
4. **内存使用**: 注意内存使用（大数据集时）

### 环境配置

1. **Python版本**: 建议使用Python 3.8+
2. **内存需求**: 大数据集需要≥8GB内存
3. **字体支持**: 可视化需要中文字体支持
4. **路径设置**: 确保数据文件路径正确

## 🔧 故障排除

### 常见问题

1. **数据读取失败**: 检查数据文件路径和格式
2. **模型拟合失败**: 调整模型参数或数据范围
3. **优化不收敛**: 增加容差或调整搜索范围
4. **分组不合理**: 检查约束参数设置
5. **可视化问题**: 检查matplotlib字体配置

### 日志文件

运行时会生成 `p2.log` 文件，包含详细的执行信息。

## 🚀 扩展功能

- **敏感性分析**: 参数扰动对结果的影响
- **模型验证**: 交叉验证和Bootstrap验证
- **自定义分组**: 支持多种BMI分组策略
- **批量处理**: 支持多数据集批量分析
- **交互式可视化**: 使用plotly生成交互式图表

## 📞 支持与反馈

如有问题或建议，请通过以下方式联系：

- **查看日志**: 首先查看`p2.log`文件中的详细错误信息
- **检查配置**: 验证`config/step2_config.yaml`参数设置
- **GitHub Issues**: 在项目仓库提交问题报告
- **邮件联系**: 发送邮件至项目维护者

---

**注意**: 本模块是Q2项目的核心分析组件，请确保在运行前已完成Step1数据预处理。
