# BMI分组与NIPT最佳检测时点分析

## 项目概述

本项目针对问题2：**男胎孕妇BMI对胎儿Y染色体浓度达标时间的影响分析**，通过建立分位数回归模型和失败风险模型，对男胎孕妇的BMI进行合理分组，给出每组的BMI区间和最佳NIPT检测时点，以最小化孕妇的潜在风险。

## 文件结构

```
step2_2/
├── p2.py                                    # 主分析程序
├── README.md                                # 项目说明文档
├── 2_2.md                                   # 详细建模策略说明
├── step1_long_records.csv                   # 输入数据（来自step2_1）
├── appendix.xlsx                            # 补充数据（QC指标）
├── bmi_groups_tau90_delta10_thr40.csv      # BMI分组结果
├── wstar_curve_tau90_delta10_thr40.csv     # 最佳时点曲线数据
├── main_analysis.png                        # 主分析图表
└── sensitivity_analysis.png                 # 敏感性分析图表
```

## 核心功能

### 1. 分位数回归建模
- **GAM模型**：使用广义加性模型捕捉非线性关系
- **增强GBR模型**：改进的梯度提升回归器，包含特征工程
- **不确定性量化**：提供90%置信度的预测区间

### 2. 失败风险建模
- **逻辑回归**：预测检测失败概率
- **特征工程**：包含二次项、交互项和QC指标
- **稳健性处理**：处理极端情况

### 3. 最佳检测时点优化
- **双条件约束**：
  - 条件1：胎儿浓度 ≥ 4%（τ分位数回归预测）
  - 条件2：检测失败风险 ≤ 10%（逻辑回归预测）
- **稳健阈值**：考虑测量误差的调整阈值
- **网格搜索**：在8-22孕周范围内寻找最优时点

### 4. 智能BMI分组
- **混合方法**：结合WHO标准和数据驱动分析
- **临床可解释性**：确保分组结果在临床上有意义
- **动态切点**：根据数据特征自动调整分组边界

## 主要结果

### BMI分组结果

| 分组 | BMI范围 | 推荐检测时点 |
|------|---------|-------------|
| [25.0, 30.0) | [27.8, 29.9) | 8.0周 |
| [30.0, 32.7) | [30.2, 32.5) | 21.25周 |
| ≥ 32.7 | [32.9, 40.9) | 22.0周 |

### 关键发现
- **总分组数**：3个BMI分组
- **分组切点**：[18.5, 25.0, 30.0, 32.7]
- **推荐时点范围**：8.0 - 22.0周
- **BMI影响**：14.0周的时点差异

### 模型性能
- **MSE改进**：相比基线模型提升26.9%
- **MAE改进**：相比基线模型提升19.3%
- **模型MSE**：0.0013
- **模型MAE**：0.0250

## 使用方法

### 环境要求
```bash
pip install pandas numpy scikit-learn matplotlib seaborn scipy
```

### 运行分析
```bash
python p2.py
```

### 参数配置
在`p2.py`文件顶部可以修改以下参数：

```python
# 核心参数
TAU = 0.90      # 分位数：0.90/0.95/0.50
THR = 0.04      # 达标阈值（比例）
SIGMA = 0.00    # 测量SD（若无就0）
DELTA = 0.10    # 失败风险容忍度（5%/10%/15%）
W_MIN, W_MAX, W_STEP = 8.0, 22.0, 0.5  # 搜索孕周范围

# 模型参数
USE_GAM = False   # 是否使用GAM模型（需要pygam库）
USE_CV = False    # 是否进行交叉验证
WHO_BMI_CUTOFFS = [18.5, 25.0, 30.0]  # WHO BMI分类标准
USE_QC = False    # 是否从appendix.xlsx合并QC指标
```

## 输出文件说明

### 数据文件
- **`bmi_groups_tau90_delta10_thr40.csv`**：BMI分组结果表格
- **`wstar_curve_tau90_delta10_thr40.csv`**：BMI网格上的最佳时点曲线数据

### 可视化文件
- **`main_analysis.png`**：主分析图表（4个子图）
  - BMI vs 推荐时点曲线
  - Y浓度散点图 + 分位曲线
  - BMI分组结果柱状图
  - BMI分布直方图
- **`sensitivity_analysis.png`**：敏感性分析图表
  - 阈值敏感性分析
  - 失败风险容忍度敏感性分析

## 敏感性分析结果

### 阈值敏感性
- 阈值0.035：时点范围14.0周
- 阈值0.04：时点范围14.0周
- 阈值0.045：时点范围14.0周

### 失败风险容忍度敏感性
- δ=0.05：时点范围0.0周
- δ=0.1：时点范围14.0周
- δ=0.15：时点范围12.5周

## 临床建议

### 风险最小化策略
- **低BMI组（< 18.5）**：可进行早期NIPT检测
- **正常BMI组（18.5-25）**：标准检测时点
- **高BMI组（> 25）**：建议延迟检测以确保准确性

### 关键优势
- 使用分位数回归确保90%置信度
- 控制失败风险在10%以内
- 结合WHO BMI标准提高临床可解释性
- 通过敏感性分析验证结果稳健性

## 技术特点

### 建模方法
- **分位数回归**：捕捉Y染色体浓度的分布特征
- **逻辑回归**：预测检测失败风险
- **决策树**：数据驱动的BMI分组
- **交叉验证**：确保模型泛化能力

### 特征工程
- 二次项和交互项
- 标准化处理
- QC指标整合
- 稳健性处理

### 可视化
- 多维度图表展示
- 中文字体支持
- 高分辨率输出
- 交互式分析

## 依赖库

```python
pandas          # 数据处理
numpy           # 数值计算
scikit-learn    # 机器学习
matplotlib      # 绘图
seaborn         # 统计绘图
scipy           # 科学计算
```

## 作者信息

- **项目**：MCM数学建模竞赛
- **功能**：BMI分组与NIPT最佳检测时点分析
- **版本**：v1.0
- **更新日期**：2025年9月

## 注意事项

1. 确保输入数据格式正确
2. 根据实际需求调整参数配置
3. 可视化需要中文字体支持
4. GAM模型需要额外安装pygam库
5. 建议在Python 3.7+环境中运行

---

*本项目为数学建模竞赛作品，仅供学术研究使用。*
