# 男胎检测数据处理流程

## 📋 概述

本模块实现了对男胎检测数据的科学化处理，将原始数据转换为适合生存分析和风险函数建模的结构化数据。通过记录级别的区间删失构造、数据驱动的异常值过滤、局部化σ估计等改进，显著提升了后续建模的严谨性与稳定性。

## 📊 数据处理流程

### 1. 提取核心变量

- **字段**：孕妇代码（ID）、检测孕周、检测日期、末次月经、身高、体重、Y染色体浓度
- **用途**：标识个体、计算孕周、计算BMI、判定达标（Y浓度≥4%）

### 2. 孕周统一化

- **文本解析**：`11w+6` → `11 + 6/7 = 11.86` 周
- **日期推算**：检测日期与末次月经差÷7
- **优先级**：文本孕周 > 日期推算
- **质量控制**：统计偏差分布，剔除>3周差异的异常个体
- **结果**：无异常个体被剔除

### 3. BMI计算与校验

- **计算**：BMI = 体重(kg) / (身高(m))²
- **校验**：与原始BMI对比，差异≤0.5则采用原始值
- **改进**：使用**首检BMI**作为分组依据，避免孕期体重增加混淆
- **标记**：保留BMI来源（原始/计算/一致）

### 4. Y染色体浓度标准化

- **转换**：统一为0-1比例
- **异常过滤**：采用数据驱动方法，使用Q99.5分位数（0.1931）替代固定阈值0.20，更适应数据分布，避免不同批次/实验室的偏差
- **结果**：剔除6条异常记录

### 5. 同日多次检测处理

- **策略**：取当日Y浓度最大值作为代表
- **达标判定**：任一检测Y≥4%则标记该日达标
- **注意**：时间分辨率降低，但避免同日低值推迟达标

### 6. 构造逐次检测长表

- **内容**：孕妇ID、检测日期、孕周、BMI、Y浓度、同日检测次数、同日是否达标
- **用途**：拟合"检测成功率 ~ 孕周 + BMI"的纵向模型

### 7. 生成事件-删失表（记录级别）

- **改进方法**：采用记录级别边界而非按周聚合，逐条记录扫描，直接寻找"最后一个<4%与第一个≥4%"的相邻对作为(L,R)，避免L=R（区间被压扁）问题，确保区间删失的准确性和时间分辨率
- **区间删失**：最近一次未达标孕周(L) → 首次达标孕周(R)
- **左删失**：首次检测即达标 (T* ≤ R)
- **右删失**：所有检测均未达标 (T* > L)
- **字段**：L、R、censor_type、BMI_base、n_records
- **生存库对齐**：生成对齐版删失表，左删失用-inf，右删失用+inf，直接兼容lifelines等生存分析库

### 8. 检测误差建模

#### 数学原理

Y染色体浓度的测量存在实验误差，忽略误差直接用"≥4%"判定达标会导致偏差。因此需要对"测量的不确定性"进行建模。

**核心思想**：将Y浓度建模为正态分布 $N(\mu(t,b), \sigma^2)$，其中$\mu(t,b)$是模型预测的平均浓度，$\sigma(t,b)$是测量噪声。

#### 全局σ估计

- **方法**：统计阈值附近（3-5%）所有样本的残差方差
- **意义**：提供整体平均的测量精度水平
- **结果**：σ = 0.0059，测量误差约0.6个百分点

#### 局部σ估计

- **问题**：不同孕周和BMI下的测量误差可能不同
  - 孕周小（浓度低）时，实验波动可能更大
  - 孕周大（浓度高）时，信号更强，波动更小
  - 高BMI孕妇血液稀释效应强，测量误差可能偏大
- **方法**：按(t,b)分箱，在每个局部区间单独估计σ(t,b)
- **结果**：12个分箱，局部方差范围[0.000000, 0.000067]

#### 风险函数建模

达标概率公式：

$$
p_{\text{succ}}(t,b) = (1-q) \cdot \Phi\left(\frac{\mu(t,b) - 0.04}{\sigma(t,b)}\right)
$$

**参数含义**：

- $p_{\text{succ}}(t,b)$：孕周t、BMI b下检测成功（Y浓度≥4%）的概率
- $\mu(t,b)$：模型预测的平均Y浓度
- $0.04$：达标阈值（4%）
- $\sigma(t,b)$：局部估计的标准差（测量噪声）
- $\Phi(\cdot)$：标准正态分布的累积分布函数
- $(1-q)$：整体实验成功率修正因子

**数学推导**：
真实观测值 $Y \sim N(\mu(t,b), \sigma(t,b)^2)$，达标概率为：

$$
P(Y \geq 0.04) = \Phi\left(\frac{\mu(t,b) - 0.04}{\sigma(t,b)}\right)
$$

#### 实际应用示例

- **孕周12周，BMI 30**：$\mu=0.035$，σ=0.007 → $p \approx 0.24$（24%成功率）
- **孕周20周，BMI 22**：$\mu=0.08$，σ=0.004 → $p \approx 1.00$（基本必然成功）

**统计结果**：199个样本，全局标准差0.0059，局部方差分箱数12

### 9. 数据质量检查

- **孕周递增**：0个个体存在非严格递增
- **异常过滤**：Q99.5分位数过滤6条记录
- **删失分布**：左删失218人(81.6%)，区间删失42人(15.7%)，右删失7人(2.6%)

### 10. 可重复配置管理

- **配置文件**：生成 `step1_config.yaml`，包含所有阈值、参数和处理策略
- **价值**：便于论文复现和实验对比

## 📈 处理结果

| 指标                 | 数值         |
| -------------------- | ------------ |
| 总记录条数           | 1,076        |
| 唯一孕妇人数         | 267          |
| 文本孕周可用比例     | 100%         |
| 日期孕周可用比例     | 0%           |
| 同日多次检测对数     | 19           |
| Y极值过滤阈值        | Q99.5=0.1931 |
| 剔除异常记录数       | 6条          |
| 孕周非严格递增个体数 | 0            |

### 区间删失类型分布

- **左删失**：218人 (81.6%) - 首次检测即达标
- **区间删失**：42人 (15.7%) - 从未达标到达标
- **右删失**：7人 (2.6%) - 所有检测均未达标

### 检测误差统计

- **阈值附近样本数**：199
- **全局标准差**：0.0059
- **全局方差**：0.000034
- **局部方差分箱数**：12
- **局部方差范围**：[0.000000, 0.000067]
- **局部方差中位数**：0.000028

## 📁 输出文件

### 核心数据文件

1. **`step1_long_records.csv`** - 逐次检测长表

   - **用途**：拟合浓度与失败概率模型
   - **字段说明**：
     - `id`：孕妇代码（唯一标识）
     - `date`：检测日期
     - `week`：检测孕周（小数形式）
     - `BMI_used`：使用的BMI值
     - `BMI_source`：BMI来源（calc_only/原始/计算/一致）
     - `Y_frac`：Y染色体浓度（0-1比例）
     - `same_day_n`：同日检测次数
     - `same_day_any_hit`：同日是否达标（0/1）
2. **`step1_surv_dat.csv`** - 基础区间删失表

   - **用途**：基础生存分析
   - **字段说明**：
     - `id`：孕妇代码（唯一标识）
     - `L`：删失下界（最近一次未达标孕周）
     - `R`：删失上界（首次达标孕周）
     - `censor_type`：删失类型（left/right/interval）
     - `BMI_base`：首检BMI值
     - `n_records`：该孕妇总检测次数
3. **`step1_surv_dat_fit.csv`** - 对齐版区间删失表 ⭐

   - **用途**：直接对接lifelines等生存分析库
   - **字段说明**：
     - `id`：孕妇代码（唯一标识）
     - `L`：删失下界（最近一次未达标孕周）
     - `R`：删失上界（首次达标孕周）
     - `censor_type`：删失类型（left/right/interval）
     - `BMI_base`：首检BMI值
     - `n_records`：该孕妇总检测次数
     - `L_fit`：拟合用下界（左删失为-inf）
     - `R_fit`：拟合用上界（右删失为+inf）

### 配置与报告文件

1. **`step1_config.yaml`** - 配置参数文件 ⭐

   - **内容**：所有阈值、参数和处理策略
   - **价值**：便于论文复现和实验对比
   - **详细配置说明**：

     ```yaml
     # 数据处理策略配置
     data_processing:
       record_level_boundaries: true      # 使用记录级别边界（避免L=R问题）
       survival_library_alignment: true   # 与生存库对齐（L_fit/R_fit列）
       use_first_bmi: true               # 使用首检BMI作为分组依据

     # σ估计配置
     sigma_estimation:
       local_binning:
         bmi_bins: 3                     # BMI分箱数（用于局部方差估计）
         week_bins: 5                    # 孕周分箱数（用于局部方差估计）
       threshold_nearby_range: [0.03, 0.05]  # 阈值附近范围（3-5%）

     # 阈值配置
     thresholds:
       Y_concentration_threshold: 0.04   # Y染色体浓度达标阈值（4%）
       Y_outlier_quantile: 0.995        # Y浓度异常值分位数（Q99.5）
       Y_outlier_threshold: 0.1931      # 实际计算的异常值阈值
       week_diff_extreme_threshold: 3.0  # 孕周差异异常阈值（3周）
     ```

2. **`step1_report.csv`** - 数据质量报告

   - **内容**：完整的处理统计和质量控制指标

## 🎯 关键优势

### 科学严谨性

- **记录级别边界**：采用逐条记录扫描，避免按周聚合导致的L=R问题，确保区间删失的准确性和时间分辨率
- **数据驱动过滤**：使用Q99.5分位数（0.1931）替代固定阈值0.20，更适应数据分布，避免不同批次/实验室的偏差
- **局部化σ估计**：按(t,b)分箱估计局部方差，为不同组合提供精准测量误差，支持风险函数建模

### 技术兼容性

- **生存库对齐**：生成L_fit/R_fit列，左删失用-inf，右删失用+inf，直接兼容lifelines等生存分析库
- **配置管理**：YAML配置文件记录所有阈值、参数和处理策略，便于论文复现和实验对比
- **质量控制**：全面的数据完整性检查，包括孕周递增性、异常值过滤、删失类型分布等

### 建模友好性

- **区间删失结构**：科学刻画达标时间不确定性，比确切事件时间更符合实际检测过程
- **首检BMI**：使用首检BMI作为分组依据，避免孕期体重增加对分组产生混淆
- **局部σ估计**：支持构建精准的风险函数 `p_succ(t,b) = (1-q)Φ((μ(t,b)-0.04)/σ(t,b))`

## 🔬 后续应用

### 生存分析

- 使用 `step1_surv_dat_fit.csv` 进行区间删失AFT/PH模型拟合
- L_fit/R_fit列直接输入lifelines等库

### 风险函数建模

- 基于局部σ估计构建 `p_succ(t,b) = (1-q)Φ((μ(t,b)-0.04)/σ(t,b))`
- 支持BMI分组优化和最优检测时点计算

### 敏感性分析

- 使用配置文件参数进行不同阈值的情景分析
- 支持论文复现和结果验证

### 配置文件使用指南

#### 读取配置

```python
import yaml
with open('step1_config.yaml', 'r', encoding='utf-8') as f:
    config = yaml.safe_load(f)

# 获取阈值参数
y_threshold = config['thresholds']['Y_concentration_threshold']  # 0.04
outlier_quantile = config['thresholds']['Y_outlier_quantile']    # 0.995

# 获取σ估计参数
week_bins = config['sigma_estimation']['local_binning']['week_bins']  # 5
bmi_bins = config['sigma_estimation']['local_binning']['bmi_bins']    # 3
```

#### 参数调整

- **修改阈值**：调整 `thresholds`部分参数，重新运行数据处理
- **修改分箱**：调整 `sigma_estimation.local_binning`参数，影响局部方差估计
- **修改策略**：调整 `data_processing`部分参数，改变处理逻辑

#### 实验复现

- 所有参数都记录在配置文件中，确保实验完全可复现
- 不同实验版本可通过配置文件对比参数差异
- 支持参数敏感性分析和最优参数搜索

---

**📌 总结**：数据处理流程不仅保留了数据细节，还通过记录级别边界、数据驱动过滤、局部化σ估计、生存库对齐、配置管理等关键改进，显著提升了后续生存分析、BMI分组优化和风险函数最小化模型的科学严谨性和技术稳定性。所有改进都融入到具体的数据处理步骤中，确保每个环节都达到科学建模的最高标准。

## 🔄 与Step2_2的集成

本模块生成的数据文件直接供Step2_2分析模块使用：

- **数据位置**: 数据文件位于 `step2_1/` 目录
- **引用方式**: Step2_2通过相对路径 `../step2_1/` 访问数据文件
- **版本同步**: 确保两个模块的版本保持一致
- **配置管理**: 使用YAML配置文件确保参数一致性

## 📝 更新日志

### v2.1.0 (2024-01-20)
- **结构优化**: 删除重复数据文件，避免存储冗余
- **路径调整**: 优化与Step2_2的数据文件引用关系
- **文档更新**: 完善与后续模块的集成说明 
 