
## 数据处理过程说明

1. **提取核心变量**
   * 从原始表格中选取了与问题2相关的字段：孕妇代码（ID）、检测孕周、检测日期、末次月经、身高、体重、Y染色体浓度。
   * 这些变量分别用于标识个体、计算孕周、计算BMI，以及判定是否达标（Y浓度≥4%）。
2. **孕周统一化**
   * 数据中“检测孕周”以文本形式记录（如  *11w+6* ），我将其解析为小数形式（例如 *11 + 6/7 = 11.86* 周）。
   * 同时利用“检测日期”与“末次月经”推算孕周（日期差÷7）。
   * 最终采用规则：若文本孕周存在，则优先使用；若缺失，则使用日期推算值。
   * 另外记录了两种孕周的差值，方便检查一致性。
3. **BMI 计算与校验**
   * 由“身高”和“体重”重新计算了 BMI = 体重(kg) / (身高(m))²。
   * 若原始表格中已给出 BMI，则对比计算值与原始值：
     * 若差异 ≤0.5，则认为一致，采用原始值；
     * 若差异明显（>0.5），则优先使用计算值。
   * 对每个孕妇保留了“BMI 来源”标记（原始、计算、还是二者一致），以保证透明性。
4. **Y 染色体浓度标准化**
   * 将“Y染色体浓度”统一为小数比例。若发现多数数值大于1，则说明原始记录为百分比，需除以100。
   * 最终得到的 `Y_frac` 范围为 0–1。
5. **同日多次检测的处理**
   * 有些孕妇在同一天做了多次检测。对同一孕妇+同一检测日期的所有记录：
     * 统计该日的检测次数；
     * 取当日 Y 浓度的最大值作为该日的代表结果；
     * 只要当日任意一次 Y≥4%，就标记该日为“达标”。
   * 这样可以避免因同日低值而推迟“首次达标”的判断。
6. **构造逐次检测长表**
   * 整理出每条检测记录：包含孕妇ID、检测日期、小数周数、BMI值、Y浓度、同日检测次数、同日是否达标。
   * 该表用于后续拟合连续型模型（如检测成功率随孕周和BMI的逻辑回归）。
7. **生成事件–删失表**
   * 以每位孕妇为单位，确定“首次达标孕周”：
     * 若某次（或某日）检测 Y≥4%，则以最早的孕周作为事件时间，标记为 `status=1`；
     * 若所有检测均未达标，则以最后一次检测的孕周作为删失时间，标记为 `status=0`。
   * 该表是生存分析/AFT模型的输入，包含字段：`event_time`（事件或删失时间）、`status`（是否观测到达标）、`BMI`（平均值）、`last_obs_week`（最后观测孕周）、`n_records`（该孕妇的检测次数）。
8. **数据质量检查**
   * 报告了数据的基本情况：总记录条数、唯一孕妇人数、文本孕周/日期孕周的可用比例、两者差值的中位数、同日多次检测的孕妇数量、BMI来源的分布等。
   * 这些指标可在论文中用来说明数据完整性与可靠性。

---

📌 总结：

通过以上步骤，我将原始的「男胎检测数据」处理为两种结构化数据：

* **逐次检测长表** → 适合建模“浓度与失败风险”。
* **事件–删失表** → 适合建模“首次达标时间”。

这样既保留了数据的细节，又形成了可直接用于后续生存分析和BMI分组建模的输入格式。

---

要不要我帮你把这部分直接改写成 **论文中的“数据预处理”段落** ，带上正式学术语言？
