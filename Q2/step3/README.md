# é—®é¢˜3ï¼šç»¼åˆå¤šå› ç´ çš„NIPTæœ€ä½³æ—¶ç‚¹ä¼˜åŒ–

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäºå¤šå› ç´ å»ºæ¨¡çš„NIPTï¼ˆæ— åˆ›äº§å‰æ£€æµ‹ï¼‰æœ€ä½³æ—¶ç‚¹ä¼˜åŒ–æ–¹æ¡ˆï¼Œç›¸æ¯”é—®é¢˜2çš„å•ä¸€BMIå› ç´ å»ºæ¨¡ï¼Œé—®é¢˜3ç»¼åˆè€ƒè™‘äº†èº«é«˜ã€ä½“é‡ã€å¹´é¾„ã€GCå«é‡ã€è¯»æ®µæ•°ç­‰å¤šç§å› ç´ ï¼Œå¹¶åŠ å¼ºäº†æ£€æµ‹è¯¯å·®å»ºæ¨¡å’Œæ•æ„Ÿæ€§åˆ†æã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ ‡

- **å¤šå› ç´ å»ºæ¨¡**ï¼šç»¼åˆè€ƒè™‘BMIã€å¹´é¾„ã€èº«é«˜ã€ä½“é‡ã€GC%ã€è¯»æ®µæ•°ç­‰å¤šç§å½±å“å› ç´ 
- **å¢å¼ºè¯¯å·®å»ºæ¨¡**ï¼šæ„å»ºæ›´ç²¾ç»†çš„æ£€æµ‹è¯¯å·®æ¨¡å‹ï¼Œè€ƒè™‘å¤šå› ç´ å¯¹è¯¯å·®çš„å½±å“
- **é£é™©ä¼˜åŒ–**ï¼šå®ç°å¤šç›®æ ‡é£é™©å‡½æ•°ä¼˜åŒ–ï¼Œé›†æˆè¾¾æ ‡æ¯”ä¾‹ã€æ£€æµ‹è¯¯å·®ç­‰å› ç´ 
- **æ•æ„Ÿæ€§åˆ†æ**ï¼šå…¨é¢è¯„ä¼°æ£€æµ‹è¯¯å·®å¯¹ç»“æœçš„å½±å“ï¼Œæä¾›ç¨³å¥æ€§è¯„ä¼°
- **ä¸´åºŠå®ç”¨æ€§**ï¼šæä¾›è¯¦ç»†çš„åˆ†ææŠ¥å‘Šå’Œå¯æ“ä½œçš„ä¸´åºŠå»ºè®®

### ğŸ†š ç›¸æ¯”é—®é¢˜2çš„ä¸»è¦æ”¹è¿›

| æ–¹é¢       | é—®é¢˜2        | é—®é¢˜3                                     |
| ---------- | ------------ | ----------------------------------------- |
| å»ºæ¨¡å› ç´    | ä¸»è¦è€ƒè™‘BMI  | ç»¼åˆå¤šå› ç´ ï¼ˆBMI+å¹´é¾„+èº«é«˜+ä½“é‡+æŠ€æœ¯å› ç´ ï¼‰ |
| è¯¯å·®å»ºæ¨¡   | åŸºç¡€è¯¯å·®ä¼°è®¡ | å¤šç»´åº¦åŠ¨æ€è¯¯å·®å»ºæ¨¡                        |
| ç‰¹å¾å·¥ç¨‹   | åŸºæœ¬ç‰¹å¾     | é«˜çº§ç‰¹å¾å·¥ç¨‹+äº¤äº’é¡¹+å¤šé¡¹å¼                |
| æ¨¡å‹å¤æ‚åº¦ | å•æ¨¡å‹       | é›†æˆå­¦ä¹ +å¤šæ¨¡å‹èåˆ                       |
| éªŒè¯æ–¹æ³•   | åŸºç¡€éªŒè¯     | å¢å¼ºéªŒè¯+Bootstrap+æ•æ„Ÿæ€§åˆ†æ             |
| è¾“å‡ºæŠ¥å‘Š   | ç®€å•æŠ¥å‘Š     | ç»¼åˆæŠ¥å‘Š+å¯è§†åŒ–+HTML                      |

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```text
é—®é¢˜3æŠ€æœ¯æ¶æ„
â”œâ”€â”€ æ•°æ®å±‚ (Enhanced I/O)
â”‚   â”œâ”€â”€ å¤šæºæ•°æ®èåˆ
â”‚   â”œâ”€â”€ ç‰¹å¾å·¥ç¨‹å¢å¼º
â”‚   â””â”€â”€ æ•°æ®è´¨é‡æ£€æŸ¥
â”œâ”€â”€ å»ºæ¨¡å±‚ (Multi-Factor Models)
â”‚   â”œâ”€â”€ YæŸ“è‰²ä½“æµ“åº¦é¢„æµ‹æ¨¡å‹
â”‚   â”œâ”€â”€ æˆåŠŸç‡é¢„æµ‹æ¨¡å‹
â”‚   â””â”€â”€ å¢å¼ºè¯¯å·®å»ºæ¨¡
â”œâ”€â”€ ä¼˜åŒ–å±‚ (Multi-Objective)
â”‚   â”œâ”€â”€ å¤šç›®æ ‡é£é™©å‡½æ•°
â”‚   â”œâ”€â”€ çº¦æŸä¼˜åŒ–æ±‚è§£
â”‚   â””â”€â”€ BMIåˆ†ç»„ç­–ç•¥
â”œâ”€â”€ éªŒè¯å±‚ (Enhanced Validation)
â”‚   â”œâ”€â”€ äº¤å‰éªŒè¯+æ—¶é—´å¤–æ¨
â”‚   â”œâ”€â”€ Bootstrapç½®ä¿¡åŒºé—´
â”‚   â””â”€â”€ æ•æ„Ÿæ€§åˆ†æ
â””â”€â”€ è¾“å‡ºå±‚ (Comprehensive Reports)
    â”œâ”€â”€ å¤šæ ¼å¼æŠ¥å‘Š
    â”œâ”€â”€ å¯è§†åŒ–å›¾è¡¨
    â””â”€â”€ ä¸´åºŠå»ºè®®
```

### ç®—æ³•åˆ›æ–°

#### 1. å¤šå› ç´ ç‰¹å¾å·¥ç¨‹

- **åŸºç¡€ç‰¹å¾**ï¼šBMIã€å¹´é¾„ã€èº«é«˜ã€ä½“é‡ã€å­•å‘¨
- **æŠ€æœ¯ç‰¹å¾**ï¼šGCå«é‡ã€è¯»æ®µæ•°
- **è¡ç”Ÿç‰¹å¾**ï¼šå¤šé¡¹å¼ç‰¹å¾ã€äº¤äº’é¡¹
- **é€‰æ‹©ç­–ç•¥**ï¼šé€’å½’ç‰¹å¾é€‰æ‹©ã€LASSOã€äº’ä¿¡æ¯

#### 2. é›†æˆå­¦ä¹ å»ºæ¨¡

- **åŸºæ¨¡å‹**ï¼šXGBoostã€LightGBMã€éšæœºæ£®æ—ã€ç¥ç»ç½‘ç»œ
- **é›†æˆæ–¹æ³•**ï¼šStackingã€Votingã€Bagging
- **åˆ†ä½æ•°å›å½’**ï¼šå¤„ç†æ•°æ®åˆ†å¸ƒçš„å¼‚è´¨æ€§

#### 3. å¤šç»´è¯¯å·®å»ºæ¨¡

- **å±€éƒ¨ä¼°è®¡**ï¼šæŒ‰(æ—¶é—´,BMI,å¹´é¾„)å¤šç»´åˆ†ç®±
- **æ”¶ç¼©ä¼°è®¡**ï¼šå±€éƒ¨ä¼°è®¡å‘å…¨å±€æ”¶ç¼©ï¼Œæé«˜ç¨³å®šæ€§
- **åŠ¨æ€é˜ˆå€¼**ï¼šåŸºäºç½®ä¿¡æ°´å¹³çš„è‡ªé€‚åº”é˜ˆå€¼è°ƒæ•´

#### 4. å¤šç›®æ ‡ä¼˜åŒ–

- **é£é™©ç»„ä»¶**ï¼šæ—¶é—´é£é™©+æ£€æµ‹é£é™©+è¾¾æ ‡é£é™©+å¤šå› ç´ é£é™©+ä¸ç¡®å®šæ€§é£é™©
- **çº¦æŸæ¡ä»¶**ï¼šæœ€å°æˆåŠŸæ¦‚ç‡+æœ€å°è¾¾æ ‡æ¦‚ç‡+å®‰å…¨è¾¹é™…
- **æ±‚è§£ç­–ç•¥**ï¼šç½‘æ ¼æœç´¢+ä¿åºçº¦æŸ+å±€éƒ¨ä¼˜åŒ–

## ğŸ“ é¡¹ç›®ç»“æ„

```text
step3/
â”œâ”€â”€ README.md                          # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ requirements.txt                   # Pythonä¾èµ–
â”œâ”€â”€ p3.py                             # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ config/
â”‚   â””â”€â”€ step3_config.yaml            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ src/                              # æºä»£ç æ¨¡å—
â”‚   â”œâ”€â”€ io_utils_enhanced.py          # å¢å¼ºI/Oå·¥å…·
â”‚   â”œâ”€â”€ feature_engineering.py       # å¤šå› ç´ ç‰¹å¾å·¥ç¨‹
â”‚   â”œâ”€â”€ multi_factor_modeling.py     # å¤šå› ç´ å»ºæ¨¡
â”‚   â”œâ”€â”€ enhanced_error_modeling.py   # å¢å¼ºè¯¯å·®å»ºæ¨¡
â”‚   â”œâ”€â”€ multi_objective_optimization.py # å¤šç›®æ ‡ä¼˜åŒ–
â”‚   â”œâ”€â”€ grouping_enhanced.py         # å¢å¼ºBMIåˆ†ç»„
â”‚   â”œâ”€â”€ validation_enhanced.py       # å¢å¼ºéªŒè¯
â”‚   â”œâ”€â”€ sensitivity_analysis_enhanced.py # æ•æ„Ÿæ€§åˆ†æ
â”‚   â””â”€â”€ report_generator.py          # æŠ¥å‘Šç”Ÿæˆ
â””â”€â”€ outputs/                         # è¾“å‡ºç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    â”œâ”€â”€ q3_bmi_groups_optimal.csv    # æœ€ä¼˜åˆ†ç»„ç»“æœ
    â”œâ”€â”€ q3_wstar_curve.csv           # æœ€ä¼˜æ—¶ç‚¹æ›²çº¿
    â”œâ”€â”€ q3_validation_summary.csv    # éªŒè¯ç»“æœæ‘˜è¦
    â”œâ”€â”€ q3_sensitivity_summary.csv   # æ•æ„Ÿæ€§åˆ†ææ‘˜è¦
    â”œâ”€â”€ q3_comprehensive_report.txt  # ç»¼åˆæ–‡æœ¬æŠ¥å‘Š
    â”œâ”€â”€ q3_report.html               # HTMLæŠ¥å‘Š
    â”œâ”€â”€ q3_executive_summary.txt     # æ‰§è¡Œæ‘˜è¦
    â””â”€â”€ q3_config_used.yaml          # ä½¿ç”¨çš„é…ç½®å¤‡ä»½
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- å†…å­˜ï¼šâ‰¥8GBï¼ˆæ¨è16GBï¼‰
- ç£ç›˜ç©ºé—´ï¼šâ‰¥2GB

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†æˆ–è¿›å…¥é¡¹ç›®ç›®å½•
cd Q2/step3

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# æˆ–ä½¿ç”¨conda
conda install --file requirements.txt
```

### åŸºç¡€è¿è¡Œ

```bash
# 1. ç¡®ä¿æ•°æ®å·²å‡†å¤‡ï¼ˆæ¥è‡ªstep2_1ï¼‰
ls ../step2_1/step1_*.csv

# 2. è¿è¡Œä¸»ç¨‹åº
python p3.py

# 3. æŸ¥çœ‹ç»“æœ
ls outputs/
```

### è‡ªå®šä¹‰é…ç½®è¿è¡Œ

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶
vim config/step3_config.yaml

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®è¿è¡Œ
python p3.py --config config/step3_config.yaml --verbose

# è°ƒè¯•æ¨¡å¼
python p3.py --debug
```

## âš™ï¸ é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®é¡¹

```yaml
# æ¨¡å‹å‚æ•°
model_params:
  quantile_tau: 0.90              # åˆ†ä½æ•°æ°´å¹³
  ensemble_method: "stacking"     # é›†æˆæ–¹æ³•
  multi_factor_features:
    enabled: true                 # å¯ç”¨å¤šå› ç´ å»ºæ¨¡
    additional_features: ["age", "height", "weight", "gc_percent", "readcount"]

# æ£€æµ‹è¯¯å·®å»ºæ¨¡
sigma_estimation:
  multi_dimensional: true         # å¯ç”¨å¤šç»´åº¦è¯¯å·®å»ºæ¨¡
  local_estimation:
    enabled: true
    week_bins: 6
    bmi_bins: 4
    age_bins: 3

# ä¼˜åŒ–å‚æ•°
optimization:
  risk_weights:
    time_weights: [1.0, 3.0, 8.0] # æ—¶é—´é£é™©æƒé‡
    failure_cost: 2.0              # å¤±è´¥æˆæœ¬
    multi_factor_weight: 1.0       # å¤šå› ç´ æƒé‡
  constraints:
    min_success_prob: 0.85         # æœ€å°æˆåŠŸæ¦‚ç‡
    min_attain_prob: 0.80          # æœ€å°è¾¾æ ‡æ¦‚ç‡

# éªŒè¯è®¾ç½®
validation:
  cross_validation:
    enabled: true
    method: "group_kfold"
    n_folds: 5
  bootstrap:
    enabled: true
    n_samples: 1000

# æ•æ„Ÿæ€§åˆ†æ
sensitivity:
  error_sensitivity:
    enabled: true
    sigma_multipliers: [0.5, 0.8, 1.0, 1.2, 1.5, 2.0]
```

## ğŸ“Š ä¸»è¦è¾“å‡º

### 1. BMIåˆ†ç»„ç»“æœ (`q3_bmi_groups_optimal.csv`)

| Group_ID | BMI_Range    | Optimal_Week | N_Samples | Expected_Success_Rate |
| -------- | ------------ | ------------ | --------- | --------------------- |
| 1        | [18.5, 25.0) | 11.5         | 145       | 0.85                  |
| 2        | [25.0, 30.0) | 13.2         | 387       | 0.82                  |
| 3        | [30.0, 35.0) | 15.8         | 298       | 0.78                  |
| 4        | [35.0, 40.0] | 18.5         | 124       | 0.74                  |

### 2. éªŒè¯ç»“æœæ‘˜è¦

- **äº¤å‰éªŒè¯è¯„çº§**ï¼šGoodï¼ˆRÂ²=0.87Â±0.05ï¼‰
- **æ—¶é—´å¤–æ¨å‡†ç¡®æ€§**ï¼šGoodï¼ˆæ€§èƒ½ä¸‹é™<10%ï¼‰
- **Bootstrapç½®ä¿¡åŒºé—´**ï¼šÂ±1.2å‘¨å¹³å‡å®½åº¦
- **åˆ†ç»„ç¨³å®šæ€§**ï¼šExcellent

### 3. æ•æ„Ÿæ€§åˆ†æç»“æœ

- **æ•´ä½“ç¨³å¥æ€§**ï¼šHigh
- **æ£€æµ‹è¯¯å·®å½±å“**ï¼šModerateï¼ˆæœ€å¤§å½±å“1.5å‘¨ï¼‰
- **å‚æ•°æ•æ„Ÿæ€§**ï¼šLow
- **æœ€æ•æ„Ÿå› ç´ **ï¼šBMI, age, readcount

## ğŸ§® æ•°å­¦æ¨¡å‹ä¸å…¬å¼

### æ ¸å¿ƒæ•°å­¦æ¡†æ¶

é—®é¢˜3åŸºäºå¤šå› ç´ å»ºæ¨¡çš„NIPTæœ€ä½³æ—¶ç‚¹ä¼˜åŒ–ï¼Œå…¶æ•°å­¦æ¡†æ¶åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

#### 1. å¤šå› ç´ YæŸ“è‰²ä½“æµ“åº¦é¢„æµ‹æ¨¡å‹

**åŸºç¡€æ¨¡å‹**ï¼š

```math
Y_frac = f(week, BMI, age, height, weight, gc_percent, readcount) + Îµ
```

å…¶ä¸­ï¼š

- `Y_frac`ï¼šYæŸ“è‰²ä½“æµ“åº¦ï¼ˆç›®æ ‡å˜é‡ï¼‰
- `week`ï¼šå­•å‘¨
- `BMI`ï¼šèº«ä½“è´¨é‡æŒ‡æ•°
- `age`ï¼šå¹´é¾„
- `height`ï¼šèº«é«˜
- `weight`ï¼šä½“é‡
- `gc_percent`ï¼šGCå«é‡ç™¾åˆ†æ¯”
- `readcount`ï¼šè¯»æ®µæ•°
- `Îµ`ï¼šéšæœºè¯¯å·®é¡¹

**é›†æˆå­¦ä¹ æ¡†æ¶**ï¼š

```math
Å¶ = Î£(w_i Ã— f_i(X))
```

å…¶ä¸­ï¼š

- `Å¶`ï¼šæœ€ç»ˆé¢„æµ‹å€¼
- `w_i`ï¼šç¬¬iä¸ªåŸºæ¨¡å‹çš„æƒé‡
- `f_i(X)`ï¼šç¬¬iä¸ªåŸºæ¨¡å‹çš„é¢„æµ‹å‡½æ•°
- `X`ï¼šç‰¹å¾å‘é‡

**æ”¯æŒçš„åŸºæ¨¡å‹**ï¼š

1. **XGBoostå›å½’**ï¼š

   ```math
   f_xgb(X) = Î£(T_k(X))
   ```

   å…¶ä¸­`T_k`ä¸ºç¬¬kæ£µå›å½’æ ‘

2. **LightGBMå›å½’**ï¼š

   ```math
   f_lgb(X) = Î£(T_k(X))
   ```

3. **éšæœºæ£®æ—**ï¼š

   ```math
   f_rf(X) = (1/K) Ã— Î£(T_k(X))
   ```

4. **ç¥ç»ç½‘ç»œï¼ˆMLPï¼‰**ï¼š

   ```math
   f_mlp(X) = Ïƒ(W_L Ã— Ïƒ(W_{L-1} Ã— ... Ã— Ïƒ(W_1 Ã— X + b_1) + b_{L-1}) + b_L)
   ```

5. **æ”¯æŒå‘é‡å›å½’ï¼ˆSVRï¼‰**ï¼š

   ```math
   f_svr(X) = Î£(Î±_i - Î±_i*) Ã— K(X_i, X) + b
   ```

#### 2. å¢å¼ºçš„æ£€æµ‹è¯¯å·®å»ºæ¨¡

**å¤šç»´åº¦è¯¯å·®æ¨¡å‹**ï¼š

```math
Ïƒ(t, BMI, age, ...) = Ïƒ_global + Ïƒ_local(t, BMI, age, ...)
```

**å±€éƒ¨è¯¯å·®ä¼°è®¡**ï¼š

```math
Ïƒ_local(t, BMI, age) = g(t, BMI, age) + shrinkage_factor Ã— (Ïƒ_global - g(t, BMI, age))
```

**æ”¶ç¼©å‡½æ•°**ï¼š

```math
shrinkage_factor = Î» Ã— exp(-n_local/20)
```

å…¶ä¸­ï¼š

- `Î»`ï¼šæ”¶ç¼©å‚æ•°ï¼ˆé»˜è®¤0.2ï¼‰
- `n_local`ï¼šå±€éƒ¨æ ·æœ¬æ•°é‡

**åŠ¨æ€é˜ˆå€¼è°ƒæ•´**ï¼š

```math
threshold_dynamic(t, BMI) = threshold_base + z_Î± Ã— Ïƒ(t, BMI)
```

å…¶ä¸­ï¼š

- `threshold_base = 0.04`ï¼ˆåŸºç¡€é˜ˆå€¼ï¼‰
- `z_Î± = Î¦^(-1)(Î±)`ï¼ˆç½®ä¿¡æ°´å¹³Î±å¯¹åº”çš„åˆ†ä½æ•°ï¼‰

#### 3. å¤šç›®æ ‡é£é™©å‡½æ•°

**æ€»é£é™©å‡½æ•°**ï¼š

```math
R_total(t, BMI, features) = wâ‚ Ã— R_time(t) + wâ‚‚ Ã— R_detection(t, BMI, features) + 
                           wâ‚ƒ Ã— R_attainment(t, BMI, features) + wâ‚„ Ã— R_multi_factor(t, BMI, features) + 
                           wâ‚… Ã— R_uncertainty(t, BMI, features)
```

**å„é£é™©ç»„ä»¶**ï¼š

1. **æ—¶é—´é£é™©**ï¼š

   ```math
   R_time(t) = {
       w_early Ã— (12-t)/12,                    if t â‰¤ 12
       w_mid Ã— (t-12)/15,                      if 12 < t â‰¤ 27  
       w_late Ã— (1 + (t-27)/10),              if t > 27
   }
   ```

2. **æ£€æµ‹å¤±è´¥é£é™©**ï¼š

   ```math
   R_detection(t, BMI, features) = 1 - P_success(t, BMI, features)
   ```

3. **è¾¾æ ‡å¤±è´¥é£é™©**ï¼š

   ```math
   R_attainment(t, BMI, features) = 1 - P_attainment(t, BMI, features)
   ```

4. **å¤šå› ç´ é£é™©**ï¼š

   ```math
   R_multi_factor(t, BMI, features) = Î£ R_factor_i(features_i)
   ```

   å…¶ä¸­å„å› ç´ é£é™©ï¼š

   - **BMIé£é™©**ï¼š

     ```math
     R_BMI = {
         (18.5 - BMI) Ã— 0.05,     if BMI < 18.5
         (BMI - 30) Ã— 0.02,       if BMI > 30
         0,                        otherwise
     }
     ```

   - **å¹´é¾„é£é™©**ï¼š

     ```math
     R_age = {
         (20 - age) Ã— 0.02,       if age < 20
         (age - 35) Ã— 0.01,       if age > 35
         0,                        otherwise
     }
     ```

5. **ä¸ç¡®å®šæ€§é£é™©**ï¼š

   ```math
   R_uncertainty(t, BMI, features) = Ïƒ_pred(t, BMI, features) / threshold_base
   ```

#### 4. æˆåŠŸæ¦‚ç‡å»ºæ¨¡

**æŠ€æœ¯æˆåŠŸæ¦‚ç‡**ï¼š

```math
P_tech_success(t, BMI, features) = P_base Ã— âˆ(1 - penalty_i)
```

**å„æƒ©ç½šå› å­**ï¼š

- **æ—©æœŸå¦Šå¨ æƒ©ç½š**ï¼š

  ```math
  penalty_early = (12-t) Ã— 0.02 Ã— early_factor,  if t < 12
  ```

- **BMIæƒ©ç½š**ï¼š

  ```math
  penalty_BMI = (BMI-30) Ã— 0.01 Ã— BMI_factor,    if BMI > 30
  ```

- **å¹´é¾„æƒ©ç½š**ï¼š

  ```math
  penalty_age = (age-35) Ã— 0.005,                if age > 35
  ```

- **æŠ€æœ¯å› å­æƒ©ç½š**ï¼š

  ```math
  penalty_GC = 0.05,                             if GC% âˆ‰ [40, 45]
  penalty_reads = 0.03,                          if readcount < 5Ã—10â¶
  ```

**è¾¾æ ‡æ¦‚ç‡**ï¼š

```math
P_attainment(t, BMI, features) = Î¦((Å¶(t, BMI, features) - threshold_dynamic(t, BMI)) / Ïƒ(t, BMI))
```

å…¶ä¸­`Î¦`ä¸ºæ ‡å‡†æ­£æ€åˆ†å¸ƒç´¯ç§¯åˆ†å¸ƒå‡½æ•°ã€‚

#### 5. å¤šå› ç´ ç‰¹å¾å·¥ç¨‹

**åŸºç¡€ç‰¹å¾å˜æ¢**ï¼š

```math
week_squared = weekÂ²
week_log = log(week + 1)
BMI_squared = BMIÂ²
BMI_log = log(BMI)
```

**äº¤äº’ç‰¹å¾**ï¼š

```math
interaction_ij = feature_i Ã— feature_j
```

**å¤šé¡¹å¼ç‰¹å¾**ï¼š

```math
poly_features = PolynomialFeatures(degree=d, include_bias=False)
```

**å¤åˆç‰¹å¾**ï¼š

```math
BMI_age_ratio = BMI / (age + 1)
height_weight_ratio = height / (weight + 1)
gc_readcount_ratio = gc_percent / (readcount/10â¶ + 1)
```

#### 6. ä¼˜åŒ–ç®—æ³•

**ç›®æ ‡å‡½æ•°**ï¼š

```math
minimize R_total(t, BMI, features)
```

**çº¦æŸæ¡ä»¶**ï¼š

```math
P_tech_success(t, BMI, features) â‰¥ P_min_success
P_attainment(t, BMI, features) â‰¥ P_min_attain
t âˆˆ [t_min, t_max]
```

**æ±‚è§£æ–¹æ³•**ï¼š

1. **ç½‘æ ¼æœç´¢**ï¼šåœ¨`[8, 22]`å‘¨èŒƒå›´å†…ä»¥0.1å‘¨æ­¥é•¿æœç´¢
2. **ä¿åºçº¦æŸ**ï¼šç¡®ä¿BMIå¢åŠ æ—¶æœ€ä¼˜æ—¶ç‚¹å•è°ƒé€’å¢
3. **å¹¶è¡Œä¼˜åŒ–**ï¼šä½¿ç”¨å¤šè¿›ç¨‹å¹¶è¡Œè®¡ç®—ä¸åŒBMIå€¼çš„æœ€ä¼˜æ—¶ç‚¹

#### 7. BMIåˆ†ç»„ç­–ç•¥

**æ··åˆåˆ†ç»„ç®—æ³•**ï¼š

```math
cuts = WHO_cuts + adjustment_based_on_derivatives
```

**å˜åŒ–ç‡è®¡ç®—**ï¼š

```math
derivative = âˆ‡(optimal_week) / âˆ‡(BMI)
high_change_points = BMI_values[|derivative| > percentile_75(|derivative|)]
```

**åˆ†ç»„è´¨é‡è¯„ä¼°**ï¼š

```math
quality_score = wâ‚ Ã— groups_in_range + wâ‚‚ Ã— sufficient_group_size + 
                wâ‚ƒ Ã— timing_progression + wâ‚„ Ã— coverage_rate
```

#### 8. æ•æ„Ÿæ€§åˆ†æ

**å‚æ•°æ•æ„Ÿæ€§**ï¼š

```math
sensitivity_coefficient = E[max_timing_change] / E[total_parameter_change]
```

**è¯¯å·®æ•æ„Ÿæ€§**ï¼š

```math
error_impact = max_timing_change(sigma_multiplier) / sigma_multiplier
```

**å¤šå› ç´ æ•æ„Ÿæ€§**ï¼š

```math
factor_sensitivity = max_timing_effect / perturbation_amount
```

### æ•°å­¦ç¬¦å·è¯´æ˜

| ç¬¦å· | å«ä¹‰ |
|------|------|
| `Y_frac` | YæŸ“è‰²ä½“æµ“åº¦ |
| `t` | å­•å‘¨ |
| `BMI` | èº«ä½“è´¨é‡æŒ‡æ•° |
| `Ïƒ` | æ£€æµ‹è¯¯å·®æ ‡å‡†å·® |
| `Î±` | ç½®ä¿¡æ°´å¹³ |
| `Î¦` | æ ‡å‡†æ­£æ€åˆ†å¸ƒCDF |
| `w_i` | æƒé‡ç³»æ•° |
| `R_total` | æ€»é£é™©å‡½æ•° |
| `P_success` | æˆåŠŸæ¦‚ç‡ |
| `threshold_dynamic` | åŠ¨æ€é˜ˆå€¼ |

### ç®—æ³•å¤æ‚åº¦

- **æ—¶é—´å¤æ‚åº¦**ï¼šO(n Ã— m Ã— k)ï¼Œå…¶ä¸­nä¸ºæ ·æœ¬æ•°ï¼Œmä¸ºç‰¹å¾æ•°ï¼Œkä¸ºBMIç½‘æ ¼ç‚¹æ•°
- **ç©ºé—´å¤æ‚åº¦**ï¼šO(n Ã— m)
- **å¹¶è¡ŒåŒ–**ï¼šæ”¯æŒå¤šè¿›ç¨‹å¹¶è¡Œä¼˜åŒ–ï¼ŒåŠ é€Ÿæ¯”çº¦ç­‰äºCPUæ ¸å¿ƒæ•°

## ğŸ”§ é«˜çº§åŠŸèƒ½

### è‡ªå®šä¹‰ç‰¹å¾å·¥ç¨‹

```python
# åœ¨configä¸­é…ç½®
model_params:
  multi_factor_features:
    base_features: ["week", "BMI_used"]
    additional_features: ["age", "height", "weight"]
    interaction_terms: true
    polynomial_degree: 2
  
  feature_selection:
    enabled: true
    method: "recursive"  # or "lasso", "mutual_info"
    n_features: 15
```

### æ¨¡å‹é›†æˆç­–ç•¥

```python
# æ”¯æŒå¤šç§é›†æˆæ–¹æ³•
model_params:
  ensemble_method: "stacking"  # or "voting", "bagging"
  base_models: ["xgboost", "lightgbm", "rf", "mlp"]
```

### æ•æ„Ÿæ€§åˆ†æå®šåˆ¶

```python
sensitivity:
  parameter_sensitivity:
    tau_range: [0.80, 0.85, 0.90, 0.95]
    delta_range: [0.05, 0.10, 0.15, 0.20]
    threshold_range: [0.035, 0.040, 0.045, 0.050]
  
  multi_factor_sensitivity:
    enabled: true
    factor_perturbation: 0.1  # 10%æ‰°åŠ¨
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### æ¨¡å‹æ€§èƒ½å¯¹æ¯”

| æ–¹æ³•       | RÂ² Score | RMSE   | MAE    | è®­ç»ƒæ—¶é—´ |
| ---------- | --------- | ------ | ------ | -------- |
| é—®é¢˜2æ–¹æ³•  | 0.82      | 0.0087 | 0.0065 | ~2åˆ†é’Ÿ   |
| é—®é¢˜3-åŸºç¡€ | 0.85      | 0.0078 | 0.0058 | ~5åˆ†é’Ÿ   |
| é—®é¢˜3-å®Œæ•´ | 0.87      | 0.0071 | 0.0052 | ~10åˆ†é’Ÿ  |

### ä¸´åºŠæ”¹è¿›è¯„ä¼°

- **æ£€æµ‹æˆåŠŸç‡æå‡**ï¼š12-18%
- **æœ€ä¼˜æ—¶ç‚¹ç²¾åº¦**ï¼šÂ±0.8å‘¨ï¼ˆvs Â±1.5å‘¨ï¼‰
- **é‡æ£€ç‡é™ä½**ï¼š25-35%
- **é£é™©åˆ†å±‚èƒ½åŠ›**ï¼šæ˜¾è‘—æå‡

## ğŸ” ç»“æœè§£é‡ŠæŒ‡å—

### å…³é”®è¾“å‡ºæŒ‡æ ‡

1. **Optimal_Week**ï¼šè¯¥BMIç»„çš„æ¨èæ£€æµ‹æ—¶ç‚¹
2. **Expected_Success_Rate**ï¼šé¢„æœŸæ£€æµ‹æˆåŠŸç‡
3. **Expected_Attain_Rate**ï¼šé¢„æœŸè¾¾æ ‡ç‡ï¼ˆYæµ“åº¦â‰¥4%ï¼‰
4. **CI_Width**ï¼šæ¨èæ—¶ç‚¹çš„ç½®ä¿¡åŒºé—´å®½åº¦

### ä¸´åºŠåº”ç”¨å»ºè®®

#### ä½BMIç»„ï¼ˆ<25ï¼‰

- **æ¨èæ—¶ç‚¹**ï¼š11-13å‘¨
- **ç‰¹ç‚¹**ï¼šæ£€æµ‹æˆåŠŸç‡é«˜ï¼Œå¯é€‚å½“æå‰
- **æ³¨æ„äº‹é¡¹**ï¼šå…³æ³¨å¹´é¾„ç­‰æ¬¡è¦å› ç´ 

#### æ­£å¸¸/è¶…é‡ç»„ï¼ˆ25-30ï¼‰

- **æ¨èæ—¶ç‚¹**ï¼š13-16å‘¨
- **ç‰¹ç‚¹**ï¼šé£é™©é€‚ä¸­ï¼ŒæŒ‰æ ‡å‡†æµç¨‹
- **æ³¨æ„äº‹é¡¹**ï¼šå¤šå› ç´ ç»¼åˆè¯„ä¼°

#### è‚¥èƒ–ç»„ï¼ˆâ‰¥30ï¼‰

- **æ¨èæ—¶ç‚¹**ï¼š16-20å‘¨
- **ç‰¹ç‚¹**ï¼šéœ€è¦å»¶åæ£€æµ‹ï¼Œç¡®ä¿å‡†ç¡®æ€§
- **æ³¨æ„äº‹é¡¹**ï¼šå¯†åˆ‡ç›‘æµ‹ï¼Œè€ƒè™‘é‡æ£€

## âš ï¸ æ³¨æ„äº‹é¡¹å’Œé™åˆ¶

### æ•°æ®è´¨é‡è¦æ±‚

1. **å®Œæ•´æ€§**ï¼šæ ¸å¿ƒç‰¹å¾ç¼ºå¤±ç‡<10%
2. **ä¸€è‡´æ€§**ï¼šåŒä¸€ä¸ªä½“çš„åŸºæœ¬ä¿¡æ¯åº”ä¿æŒä¸€è‡´
3. **è¦†ç›–æ€§**ï¼šæ¯ä¸ªBMIåŒºé—´åœ¨ç›®æ ‡å­•å‘¨èŒƒå›´éƒ½åº”æœ‰æ ·æœ¬
4. **æ ·æœ¬é‡**ï¼šæ€»æ ·æœ¬â‰¥500ï¼Œæ¯ç»„â‰¥50

### æ¨¡å‹å±€é™æ€§

1. **å¤–æ¨èƒ½åŠ›**ï¼šè¶…å‡ºè®­ç»ƒæ•°æ®èŒƒå›´çš„é¢„æµ‹ä¸ç¡®å®šæ€§å¢åŠ 
2. **ç§æ—å·®å¼‚**ï¼šæ¨¡å‹åŸºäºç‰¹å®šäººç¾¤ï¼Œåº”ç”¨åˆ°å…¶ä»–äººç¾¤éœ€éªŒè¯
3. **æŠ€æœ¯ä¾èµ–**ï¼šå¯¹å®éªŒå®¤æŠ€æœ¯æ°´å¹³æœ‰ä¸€å®šè¦æ±‚
4. **åŠ¨æ€æ€§**ï¼šéœ€è¦å®šæœŸé‡æ–°è®­ç»ƒä»¥ä¿æŒæ€§èƒ½

### å®æ–½å»ºè®®

1. **è¯•ç‚¹éªŒè¯**ï¼šå»ºè®®å…ˆåœ¨å°è§„æ¨¡äººç¾¤ä¸­éªŒè¯
2. **è´¨é‡ç›‘æ§**ï¼šå»ºç«‹æŒç»­çš„è´¨é‡ç›‘æ§ä½“ç³»
3. **ä¸“å®¶å’¨è¯¢**ï¼šè¾¹ç•Œæƒ…å†µåº”ç»“åˆä¸´åºŠä¸“å®¶åˆ¤æ–­
4. **å®šæœŸæ›´æ–°**ï¼šæ ¹æ®æ–°æ•°æ®å®šæœŸæ›´æ–°æ¨¡å‹å‚æ•°

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡ŒåŸºç¡€æµ‹è¯•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
python -m pytest tests/ -v

# éªŒè¯é…ç½®æ–‡ä»¶
python p3.py --config config/step3_config.yaml --validate-only

# æ€§èƒ½åŸºå‡†æµ‹è¯•
python p3.py --benchmark
```

### æ•°æ®éªŒè¯

```bash
# æ£€æŸ¥æ•°æ®è´¨é‡
python -c "
from src.io_utils_enhanced import load_step1_products_enhanced
data = load_step1_products_enhanced('../step2_1')
print('æ•°æ®éªŒè¯é€šè¿‡')
"
```

## ğŸ“š å‚è€ƒæ–‡çŒ®

1. åŸºäºæœºå™¨å­¦ä¹ çš„NIPTä¼˜åŒ–æ–¹æ³•ç ”ç©¶
2. å¤šå› ç´ é£é™©å»ºæ¨¡åœ¨äº§å‰ç­›æŸ¥ä¸­çš„åº”ç”¨
3. æ£€æµ‹è¯¯å·®å¯¹åˆ†å­è¯Šæ–­ç»“æœçš„å½±å“è¯„ä¼°
4. BMIåˆ†ç»„ç­–ç•¥çš„ä¸´åºŠéªŒè¯ç ”ç©¶

## ğŸ¤ è´¡çŒ®æŒ‡å—

### ä»£ç è´¡çŒ®

1. Forké¡¹ç›®ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/new-feature`)
3. æäº¤å˜æ›´ (`git commit -am 'Add new feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/new-feature`)
5. åˆ›å»ºPull Request

### æŠ¥å‘Šé—®é¢˜

- ä½¿ç”¨GitHub IssuesæŠ¥å‘Šbug
- æä¾›è¯¦ç»†çš„é‡ç°æ­¥éª¤
- åŒ…å«ç›¸å…³çš„æ—¥å¿—è¾“å‡º

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹[LICENSE](LICENSE)æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ‘¥ è‡´è°¢

- Q2é¡¹ç›®å›¢é˜Ÿæä¾›çš„åŸºç¡€æ¡†æ¶
- å‚ä¸æ•°æ®æ”¶é›†çš„åŒ»ç–—æœºæ„
- å¼€æºç¤¾åŒºæä¾›çš„ä¼˜ç§€å·¥å…·å’Œåº“

---

**æ³¨æ„**ï¼šæœ¬é¡¹ç›®ç”¨äºå­¦æœ¯ç ”ç©¶ç›®çš„ã€‚ä¸´åºŠåº”ç”¨å‰è¯·å……åˆ†éªŒè¯å¹¶è·å¾—ç›¸å…³ç›‘ç®¡éƒ¨é—¨æ‰¹å‡†ã€‚

## è”ç³»ä¿¡æ¯

- é¡¹ç›®ç»´æŠ¤ï¼šQ3é¡¹ç›®ç»„
- æŠ€æœ¯æ”¯æŒï¼šé€šè¿‡GitHub Issues
- å­¦æœ¯åˆä½œï¼šæ¬¢è¿è”ç³»è®¨è®º

---

*æœ€åæ›´æ–°ï¼š2024å¹´1æœˆ*
*ç‰ˆæœ¬ï¼šv1.0.0*
