# 同一天多次检测数据处理方法说明

## 问题描述

在原始数据中，发现有些孕妇在同一天进行了多次检测，这可能是由于：
1. 重复抽血检测
2. 数据录入错误
3. 质量控制需要

## 处理方法

### 1. 识别重复数据
```python
# 按孕妇代码和检测日期分组，统计每组记录数
duplicate_check = data.groupby(['孕妇代码', '检测日期']).size()
duplicates = duplicate_check[duplicate_check > 1]
```

### 2. 数据合并策略

对于同一天多次检测的数据，采用以下合并策略：

#### 2.1 数值型变量 - 取平均值
- **Y染色体浓度**: 取平均值 (`mean`)
- **孕妇BMI**: 取平均值 (`mean`) 
- **检测孕周**: 取平均值 (`mean`)
- **体重**: 取平均值 (`mean`)

#### 2.2 分类变量 - 取第一个值
- **年龄**: 取第一个值 (`first`) - 年龄通常不变
- **身高**: 取第一个值 (`first`) - 身高通常不变

#### 2.3 质量监控指标
- **Y染色体浓度标准差**: 计算标准差 (`std`) - 用于评估检测一致性
- **检测次数**: 记录检测次数 (`count`) - 用于追踪

### 3. 具体实现代码

```python
data_grouped = data.groupby(['孕妇代码', '检测日期']).agg({
    'Y染色体浓度': ['mean', 'std', 'count'],  # 均值、标准差、次数
    '孕妇BMI': 'mean',                        # 均值
    '检测孕周_数值': 'mean',                   # 均值
    '年龄': 'first',                          # 第一个值
    '身高': 'first',                          # 第一个值
    '体重': 'mean',                           # 均值
}).reset_index()
```

### 4. 质量检查

#### 4.1 标准差检查
```python
# 检查Y染色体浓度标准差，标记可能的异常数据
high_std_mask = data_grouped['Y染色体浓度_标准差'] > 0.01
```

如果同一天检测的Y染色体浓度标准差 > 0.01，说明两次检测结果差异较大，可能需要进一步检查。

#### 4.2 处理结果统计
- 发现19个孕妇在同一天进行了多次检测
- 所有重复检测都成功合并
- 合并后数据量从1081条减少到1062条

## 处理结果示例

| 孕妇代码 | 检测日期 | Y染色体浓度(均值) | 标准差 | 检测次数 |
|---------|---------|------------------|--------|----------|
| A003    | 2023-05-26 | 0.060948 | 0.005992 | 2 |
| A010    | 2023-07-18 | 0.029424 | 0.003567 | 2 |
| A023    | 2023-06-16 | 0.041362 | 0.003106 | 2 |

## 方法优势

1. **保持数据完整性**: 不丢失任何检测信息
2. **提高数据质量**: 通过取平均值减少随机误差
3. **质量监控**: 通过标准差评估检测一致性
4. **可追溯性**: 保留检测次数信息

## 注意事项

1. 标准差阈值(0.01)可根据实际需要调整
2. 对于标准差过大的记录，建议人工检查原始数据
3. 合并后的数据更适合进行统计分析
4. 保留了所有原始信息，便于后续分析
