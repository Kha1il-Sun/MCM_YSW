### **步骤 1：数据预处理**

**在数据预处理过程中，我们将按以下详细步骤进行操作，确保数据适用于模型训练和分析。如果某些孕妇在同一天进行了两次测试，我们将合理地处理这些数据。**

#### **1. 筛选男胎数据**

**由于****Y染色体浓度**只适用于男胎，因此我们首先筛选出有**Y染色体浓度**的数据，确保只分析男胎的数据。

#### **2. 清洗数据**

* **去除缺失值**：对于缺失的Y染色体浓度、孕周数、BMI等重要特征的样本，我们将从数据中移除。
* **去除异常值**：例如，BMI过高或过低，孕周数过大或过小，可能代表数据输入错误。

#### **3. 转换孕周格式**

**孕周的格式可能是****“周+天”**（例如，12w+3），我们将其转换为以周为单位的数值，便于后续分析。

#### **4. 处理同一天检测的重复数据**

* **如果同一孕妇在同一天进行了多次测试，我们需要将这些测试结果合并。**
  * **取平均值**：对于同一天进行的重复检测，建议取**Y染色体浓度、BMI**等的平均值，作为该孕妇当天的最终测量值。
  * **检查标准差**：如果两次测试结果差异很大，可能需要标记为异常数据进行剔除或进一步检查。

#### **5. 提取特征**

* **我们将选择****孕周数**、**BMI**作为自变量，并选择**Y染色体浓度**作为因变量。

### **详细步骤与代码实现**

```
 import pandas as pd
 import numpy as np
 
 # 读取数据
 data = pd.read_excel('附件.xlsx')
 
 # 1. 筛选男胎数据：只保留有Y染色体浓度的记录
 male_data = data[data['Y染色体浓度'].notnull()]
 
 # 2. 清洗数据：去除缺失值（保留孕周数、BMI和Y染色体浓度等有用列）
 male_data_cleaned = male_data.dropna(subset=['Y染色体浓度', '孕妇的孕周', 'BMI'])
 
 # 3. 转换孕周格式：从"w+d"格式转换为以周为单位的数值
 def week_to_numeric(week_str):
     # 例："12w+3" 转为 12.43
     weeks, days = week_str.split('w+')
     return int(weeks) + int(days) / 7
 
 male_data_cleaned['孕妇的孕周'] = male_data_cleaned['孕妇的孕周'].apply(week_to_numeric)
 
 # 4. 处理同一天检测的重复数据
 # 假设"检测日期"列格式是 YYYYMMDD，确保格式一致
 male_data_cleaned['检测日期'] = pd.to_datetime(male_data_cleaned['检测日期'], format='%Y%m%d')
 
 # 按"孕妇代码"和"检测日期"分组，计算每个组内的均值（对于Y染色体浓度和BMI）
 # 也可以计算标准差来查看两次测试的差异
 data_grouped = male_data_cleaned.groupby(['孕妇代码', '检测日期']).agg({
     'Y染色体浓度': 'mean',  # 取均值
     'BMI': 'mean',           # 取均值
     '孕妇的孕周': 'mean',     # 取均值
 }).reset_index()
 
 # 5. 提取特征：选择孕周数、BMI作为自变量，Y染色体浓度作为因变量
 X = data_grouped[['孕妇的孕周', 'BMI']]  # 自变量
 y = data_grouped['Y染色体浓度']  # 因变量
 
 # 检查数据处理后的结果
 print(data_grouped.head())
```

### **解释每一步**

#### **1. 筛选男胎数据**

* `male_data = data[data['Y染色体浓度'].notnull()]` 这行代码确保我们只选取有Y染色体浓度的样本，忽略所有女胎的记录。

#### **2. 清洗数据**

* `male_data_cleaned = male_data.dropna(subset=['Y染色体浓度', '孕妇的孕周', 'BMI'])` 这行代码删除了缺失Y染色体浓度、孕周数或BMI的样本。

#### **3. 转换孕周格式**

* `week_to_numeric(week_str)` 函数将**孕周数**从“周+天”的格式转换为以周为单位的小数形式。

#### **4. 处理同一天检测的重复数据**

* **通过** `male_data_cleaned.groupby(['孕妇代码', '检测日期'])`将数据按**孕妇代码**和**检测日期**进行分组，然后对每个组内的**Y染色体浓度**、**BMI**和**孕妇的孕周**取**均值**，以解决同一天多次测试的问题。
  * **我们通过** `agg({'Y染色体浓度': 'mean', 'BMI': 'mean', '孕妇的孕周': 'mean'})`来计算均值。对于其他统计指标（如标准差），你可以进一步检查两次测试的差异。

#### **5. 提取特征**

* **提取了****孕周数**和**BMI**作为自变量，**Y染色体浓度**作为因变量，准备后续进行回归分析。
